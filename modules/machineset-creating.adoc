// Module included in the following assemblies:
//
// * machine-management/creating-infrastructure-machinesets.adoc

[id="machineset-creating-{context}"]
= Creating a MachineSet

You can create more MachineSets. Because the MachineSet definition contains
details that are specific to the Amazon Web Services (AWS) region that the
cluster is deployed in, you copy an existing MachineSet from your cluster and
modify it.

.Prerequisites

* Deploy an {product-title} cluster.
* Install the `oc` command line and log in as a user with `cluster-admin`
permission.

.Procedure

. View the current MachineSets.
+
----
$ oc get machinesets -n openshift-machine-api

NAME                         DESIRED   CURRENT   READY     AVAILABLE   AGE
190125-3-worker-us-west-1b   2         2         2         2           3h
190125-3-worker-us-west-1c   1         1         1         1           3
----

. Export the source of a MachineSet to a text file:
+
----
$ oc get machineset <machineset_name> -n \
     openshift-machine-api -o yaml > <file_name>.yaml
----
+
In this command, `<machineset_name>` is the name of the current MachineSet that
is in the AWS region you want to place your new MachineSet in, such
as `190125-3-worker-us-west-1c`, and `<file_name>` is the name of your new
MachineSet definition.

. Update the `metadata` section of `<file_name>.yaml`:
+
[source,yaml]
----
metadata:
  creationTimestamp: 2019-02-15T16:32:56Z <1>
  generation: 1 <1>
  labels:
    machine.openshift.io/cluster-api-cluster: <cluster_name> <2>
    machine.openshift.io/cluster-api-machine-role: <machine_label> <3>
    machine.openshift.io/cluster-api-machine-type: <machine_label> <3>
  name: <cluster_name>-<machine_label>-<AWS-availability-zone> <3> <4>
  namespace: openshift-machine-api
  resourceVersion: "9249" <1>
  selfLink: /apis/cluster.k8s.io/v1alpha1/namespaces/openshift-machine-api/machinesets/<cluster_name>-<machine_label>-<AWS-availability-zone> <1>
  uid: 59ba0425-313f-11e9-861e-0a18047f0a28 <1>
----
<1> Remove this line.
<2> Do not change the `<cluster_name>`.
<3> For each `<machine_label>` instance, specify the name of the new MachineSet.
<4> Ensure that the AWS availability zone is correct in each instance of the
`<AWS-availability-zone>` parameter.
+
The `metadata` section resembles the following YAML:
+
[source,yaml]
----
metadata:
  labels:
    machine.openshift.io/cluster-api-cluster: <cluster_name>
    machine.openshift.io/cluster-api-machine-role: <new_machine_label>
    machine.openshift.io/cluster-api-machine-type: <new_machine_label>
  name: <cluster_name>-<new_machine_label>-<AWS-availability-zone>
  namespace: openshift-machine-api
----

. In `<file_name>.yaml`, delete the `status` stanza:
+
[source,yaml]
----
status:
  availableReplicas: 1
  fullyLabeledReplicas: 1
  observedGeneration: 1
  readyReplicas: 1
  replicas: 1
----

. In `<file_name>.yaml`, update both instances of the `machine.openshift.io/cluster-api-machineset` parameter
values in the `spec` section to match the `name` that you defined in the `metadata` section:
+
[source,yaml]
----
spec:
  replicas: 1
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: cluster_name
      machine.openshift.io/cluster-api-machineset: <cluster_name>-<machine_label>-<AWS-availability-zone> <1>
  template:
    metadata:
      creationTimestamp: null
      labels:
        machine.openshift.io/cluster-api-cluster: <cluster_name>
        machine.openshift.io/cluster-api-machine-role: <machine_label>
        machine.openshift.io/cluster-api-machine-type: <machine_label>
        machine.openshift.io/cluster-api-machineset: <cluster_name>-<machine_label>-<AWS-availability-zone> <1>
...
----
<1> Ensure that both the `machine.openshift.io/cluster-api-machineset` parameter values
match the `name` that you defined in the `metadata` section.

. In `<file_name>.yaml`, add the node label definition to the spec. The label
definition resembles the following stanza:
+
[source,yaml]
----
  spec:
    metadata:
      labels:
        node-role.kubernetes.io/<label_name>: "" <1>
----
<1> In this definition, `<label_name>` is the node label to add. For example, to
add the `infra` label to the nodes, specify `node-role.kubernetes.io/infra`.
+
The updated `spec` section resembles this example:
+
[source,yaml]
----
spec:
  replicas: 1
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: cluster_name
      machine.openshift.io/cluster-api-machineset: <cluster_name>-<machine_label>-<AWS-availability-zone>
  template:
    metadata:
      creationTimestamp: null
      labels:
        machine.openshift.io/cluster-api-cluster: <cluster_name>
        machine.openshift.io/cluster-api-machine-role: <machine_label>
        machine.openshift.io/cluster-api-machine-type: <machine_label>
        machine.openshift.io/cluster-api-machineset: <cluster_name>-<machine_label>-<AWS-availability-zone>
    spec: <1>
      metadata:
        labels:
          node-role.kubernetes.io/<label_name>: ""
...
----
<1> Place the `spec` stanza here.

. Optionally, modify the EC2 instance type and modify the storage volumes.
+
[IMPORTANT]
====
Take care to modify only the parameters that describe the EC2 instance type
and storage volumes. You must not change the other parameters value in the
`providerSpec` section.
====
+
[source,yaml]
----
providerSpec:
  value:
    ami:
      id: ami-0e2bcd33dfff9c73e <1>
    apiVersion: awsproviderconfig.k8s.io/v1alpha1
    blockDevices: <2>
    - ebs:
        iops: 0
        volumeSize: 120
        volumeType: gp2
    deviceIndex: 0
    iamInstanceProfile: <3>
      id: <cluster_name>-<machine_label>-profile
    instanceType: m4.large <4>
    kind: AWSMachineProviderConfig
    metadata:
      creationTimestamp: null
    placement: <3>
      availabilityZone: <AWS-availability-zone>
      region: <AWS-region>
    publicIp: null
    securityGroups:
    - filters:
      - name: tag:Name
        values:
        - <cluster_name>-<machine_label>-sg
    subnet: <3>
      filters:
      - name: tag:Name
        values:
        - <cluster_name>-private-<AWS-availability-zone>
    tags:
    - name: kubernetes.io/cluster/<cluster_name>
      value: owned
    userDataSecret: <3>
      name: <machine_label>-user-data
----
<1> You can specify a different valid AMI.
<2> You can customize the volume characteristics for the MachineSet. See the AWS
documentation.
<3> Do not modify this section.
<4> Specify a valid `instanceType` for the AMI that you specified.

. Create the new `MachineSet`:
+
----
$ oc create -f <file_name>.yaml
----

. View the list of MachineSets:
+
----
$ oc get machineset -n openshift-machine-api


NAME                         DESIRED   CURRENT   READY     AVAILABLE   AGE
190125-3-worker-us-west-1b   2         2         2         2           4h
190125-3-worker-us-west-1c   1         1         1         1           4h
infrastructure-us-west-1b    1         1                               4s
----
+
When the new MachineSet is available, the `DESIRED` and `CURRENT` values match.
If the MachineSet is not available, wait a few minutes and run the command again.

. After the new MachineSet is available, check the machine status:
+
----
$ oc get machine -n openshift-machine-api
----

. View the new node:
+
----
$ oc get node
----
+
The new node is the one with the lowest `AGE`.  ip-10-0-128-138.us-west-1.compute.internal

. Confirm that the new node has the label that you specified:
+
----
$ oc get node <node_name> --show-labels
----
+
Review the command output and confirm that `node-role.kubernetes.io/<your_label>`
is in the `LABELS` list.

.Next steps
If you need MachineSets in other availability zones, repeat this
process to create more MachineSets.
